<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Send Webpage to Kindle</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/readability/0.6.0/Readability.js" integrity="sha512-cY9LjZzucgo2OKzTs/0J5LrG2IqeDv2CB+0JQ6O9B+J6Mu+fKZ4qI5/NxnGQq6AGx2mtsJhWLuAfBsV7gPnoZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js" integrity="sha512-YlctBG9PGZIhh9keoqI3eZkQM9T8QUbiBi7qNYAO/TUEo8jqWX5pLp5+x1cKRQDRzJ/lyGyJ9WUVNIRduxIIFw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="auth.js"></script>
		<link rel="stylesheet" href="/main.css"/>
		<link rel="stylesheet" href="/preview.css"/>
		<link rel="icon" href="/icon.svg"/>
	</head>
	<body>
		<div id="main">
			<h1>Send Webpage to Kindle</h1>
			<p>Take a url, convert it into a readable document, and send it to your kindle mail through your gmail.</p>
			<details>
				<summary>Security and Usage Instructions</summary>
				<ol>
					<li>Audit the code here: (<a target="_blank" href="https://github.com/Krishna-Sivakumar/kindlify-webpage/blob/master/src/index.js">src/index.js</a> for the email stuff)</li>
					<li>Use the URL Preview below to check out what your document would look like on the kindle.</li>
					<li>Make sure your gmail is added to your <a href="https://www.amazon.com/sendtokindle/email">kindle's approved list.</a></li>
				</ol>
			</details>
			<div class="form-container">
				<div class="form">
					<button type="button" id="login" style="display:none">Login with Google</button>
					<input id="data-url" type="text" id="url" placeholder="url" />
					<input id="data-kindle-mail" type="text" id="target-mail" placeholder="kindle email: name@kindle.com" />
					<input type="text" id="opt-title" placeholder="Document Name" style="margin-top: 0.25rem;" />
					<button id="preview" type="button"><img src="preview.svg">Preview</button>
					<button id="send" type="button" style="margin: 0.25rem 0;"><img src="send.svg">Send to Kindle</button>
				</div>
			</div>
			<hr/>
			<h2>Preview</h2>
			<div id="preview-box">
				<p>Nothing as of now.</p>
			</div>

			<script>
				const emailbox = document.querySelector("#data-kindle-mail");
				const send = document.querySelector("#send");
				const preview = document.querySelector("#preview");
				const login = document.querySelector("#login");

				function getUrl() {
					return document.querySelector('#data-url').value;
				}

				function isRelativeURI(url) {
					var pat = /^https?:\/\//i;
					return pat.test(urlString)
				}

				window.onload = () => {
					const storedMail = window.localStorage.getItem('stored-mail') || ""
					if (storedMail != "") {
						emailbox.value = storedMail
					}

					fetch('/loginstatus')
						.then(response => response.text())
						.then(text => {
							if (text != 'ok') {
								login.style = "display: block";
							}
						})
						.catch(err => console.log(err))

				}

				async function parseUrl(fetchUrl) {
					const response = await fetch('/url?' + new URLSearchParams({url: fetchUrl}).toString())
					const cleanedResponse = DOMPurify.sanitize(await response.text())
					const doc = new DOMParser().parseFromString(cleanedResponse, 'text/html')
					const parsedDoc = new Readability(doc).parse()

					if (parsedDoc.title == "") {
						alert("Could not infer a title from the webpage. Set the document's name in the textbox above.")
					} else {
						document.querySelector("#opt-title").value = parsedDoc.title;
					}

					const previewBox = document.querySelector("#preview-box")


					previewBox.setHTMLUnsafe(parsedDoc.content)

					// convert all pre tags to divs
					let pretags = document.querySelectorAll("pre");
					pretags.forEach(tag => {
						let div = document.createElement("div")
						div.className = "code"
						tag.textContent.split('\n').forEach(line => {
							let para = document.createElement("p")
							const spacing = "&nbsp;".repeat(line.length - line.trimLeft().length);
							para.innerHTML = spacing + line.trimLeft()
							div.append(para)
						})
						tag.parentNode.insertBefore(div, tag);
						tag.remove()
					})

					// images can have relative or absolute sources.
					// relative sources can be relative to the origin or the origin + path of the original link.
					// I encapsulate all of this below.
					previewBox.querySelectorAll("img").forEach(img => {
						const fetchUri = new URL(fetchUrl);
						let imglink = img.src.replaceAll(window.location.href, '');
						if (img.src.indexOf("http") != 0) {
							img.src = fetchUri.origin + '/' + imglink;
						}
						img.onerror = () => { this.src = fetchUri.href + '/' + imglink }
					})

					const allowed_list = ['a', 'abbr', 'acronym', 'address', 'applet', 'b', 'bdo', 'big', 'blockquote', 'br', 'cite', 'code', 'del', 'dfn', 'div', 'dl', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'iframe', 'img', 'ins', 'kbd', 'map', 'noscript', 'ns:svg', 'object', 'ol', 'p', 'pre', 'q', 'samp', 'script', 'small', 'span', 'strong', 'sub', 'sup', 'table', 'tt', 'ul', 'var', 'article', 'section', 'li'];

					/*
					* Cleans up the DOM for conversion into an EPUB.
					* EPUBs do not allow data attributes and anything not in the allowed list.
					* technically, some tags do work even when epubcheck flags them, but it's on a case-by-case basis, for eg. section and article.
					*/
					function cleanForEPUB(node) {
						node.childNodes.forEach(child => cleanForEPUB(child));

						if (node.getAttributeNames) {
							node.getAttributeNames().forEach(attr => {
								if (attr.indexOf('data-') != -1) {
									node.removeAttribute(attr);
								}
							})
						}

						if (node.tagName != undefined) {
							if (allowed_list.indexOf(node.tagName.toLowerCase()) == -1) {
								console.log("remove", node.tagName);
								node.remove();
							}
						}
					}
					cleanForEPUB(previewBox);

					// relative hrefs are adjusted to be relative to the original link
					previewBox.querySelectorAll("a").forEach(tag => {
						const fetchUri = new URL(fetchUrl);
						tag.href = tag.href.replace(window.location.href, fetchUri.origin + '/')
					})
				}

				emailbox.addEventListener('change', (event) => {
					window.localStorage.setItem('stored-mail', event.target.value)
				})

				login.addEventListener('click', async () => {
					oauth2SignIn();
				})

				preview.addEventListener('click', async () => {
					const data_url = document.querySelector('#data-url');
					data_url.setAttribute('data-error', '')
					if (data_url.value.trim().length == 0) {
						setTimeout(() => data_url.setAttribute('data-error', 'error'), 50);
						return
					}

					await parseUrl(getUrl());
					window.location.hash = '';
					window.location.hash = 'preview-box';
				})

				const sendMonitor = (handler) => {
					return async () => {
						send.disabled = true;
						await handler()
						send.disabled = false;
					}
				}

				send.addEventListener("click", sendMonitor(async () => {
					const data_url = document.querySelector('#data-url');
					const data_mail = document.querySelector('#data-kindle-mail');
					const data_title = document.querySelector('#opt-title');

					[data_mail, data_title, data_url].forEach(node => node.setAttribute('data-error', ''));

					const empties = [data_mail, data_title, data_url].filter(node => node.value.trim().length == 0)
					if (empties.length != 0) {
						empties.forEach(node => setTimeout(() => node.setAttribute('data-error', 'error'), 50))
						return;
					}


					await parseUrl(getUrl())
					const mailaddr = document.querySelector('#data-kindle-mail').value
					const filename = document.querySelector("#opt-title").value;
					if (filename == "") {
						alert("Could not infer a title from the webpage. Set the document's name in the textbox above.")
						return
					}
					if (mailaddr == "") {
						alert("Need a kindle mail address to send to.")
						return
					}

					const previewBox = document.querySelector("#preview-box")
					const previewClone = previewBox.cloneNode(true);

					imgSources = previewClone.querySelectorAll("img").values().map(tag => tag.src).toArray()
					previewClone.querySelectorAll("img").forEach(tag => {
						const name = tag.src.split("/").at(-1);
						tag.loading = "lazy";
						tag.src = "images/" + name;
					})

					previewClone.querySelector("#readability-page-1").id = "preview-box";

					const response = await fetch('/upload', {
						method: "POST",
						body: JSON.stringify({
							kindle_email: document.querySelector('#data-kindle-mail').value,
							filename: document.querySelector('#opt-title').value,
							content: previewClone.innerHTML,
							img_sources: imgSources,
						})
					})
					const responseText = await response.text()

					if (responseText == 'ok') {
						alert('Mail sent!');
					} else {
						alert(responseText)
					}
				}));

			</script>
		</div>
	</body>
</html>
